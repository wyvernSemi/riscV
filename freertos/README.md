# FreeRTOS port for rv32
This directory contains a port of Amazon Web Service's [FreeRTOS](https://www.freertos.org/) real-time operating system, meant as an example of running an embedded OS on the RISC-V model. Currently this has only been tested on the instructions set simulator (ISS) on both Linux and Windows (under mingw64), but will be ported to the HDL soon. There is a `makefile` for compiling the OS and some demonstration code in the `demo` directory, which produces a `main.exe` executable. It expects FreeRTOS to be checked out from [github](https://github.com/FreeRTOS) in the same directory as the `riscV` directory, or this can be overridden using the makefile's `FREERTOSDIR` variable.

To run this with the ISS, from the `iss/freertos` folder, use:

```
   <path to ISS executable folder>/rv32.exe -t main.exe
```
The demo spawns two tasks which print different decrementing counts using the delay features of the operating system. After counting down for a number of iteration, the tasks go into an endless sleep loop. (Use `CRTL-C` to break out of the code.)

By default the ISS will use a real-time clock for the CSR `mtime` register, used by FreeRTOS to generate its scheduler "ticks".  Although this gives accurate timing to delays, schedule times etc., it does mean re-running of code has an unpredictable element and subsequent runs may behave slightly differently. The `mtime` value can be switched to using the "instructions retired" count (CSR register `minstret`) instead by adding the `-C` option on the command line. The rate at which this advances in real time will now be dependent on how fast the ISS runs on a given system, and so some scaling factor in the `configTICK_RATE_HZ` or `configCPU_CLOCK_HZ` may be required in the `FreeRTOSConfig.h` file, located in the `iss/freertos/rv32` directory. It should, at least, run the same every time.

For the demonstration the `FreeRTOSConfig.h` has been set up for a minimal inclusion of functionality in order to make the code footprint small. However, the ISS has a memory model that can span the entire 32-bit address space, and so the FreeRTOS configuration may be expanded to include whichever features are desired. The actual configured size of the ROM and RAM portions of the compiled source code are defined in the linker script `rv32.ld`, located in `iss/freertos`.

Since the ISS does not run at the full speed of the HDL (e.g. at 100MHz), the `configTICK_RATE_HZ` and `configCPU_CLOCK_HZ` values in `FreeRTOSConfig.h` need to be adjusted accordingly. The HDL uses an `mtime` rate of 1&#956;s and, by default, so does the ISS. Therefore the `configCPU_CLOCK_HZ` definition can be set to 1MHz. The `configTICK_RATE_HZ` for HDL running at, say, 100MHz might usefully be set between 100 (a 10ms tick rate) and 1000 (a 1ms tick rate). When running on the ISS, this must be reduced to compensate for the slower rate of instruction execution. If the tick rate is too high, the timer task (which is the highest priority) will not complete before a new tick needs servicing, and so will starve the user tasks of run time. The value should be lowered and is set to 10Hz (a 100ms tick rate) for the demonstration. This is a trade off between allowing tasks sufficient time to run and the resolution of time for such things as delays, being limited to a tenth of a second with the example settings.

The `rv32.ld` linker scripts is a very stripped down version of that found in the [neorv32](https://github.com/stnolting/neorv32) project, and the `crt0.S` C run-time start up code, found in `iss/freertos/rv32` is from this same source, with modifications to be able to remove certain sections at compile time. Both files retain the appropiate headers, and more details can be found there. For the `printf` functionality, Marco Paland's [printf](https://github.com/mpaland/printf) for embedded systems code has been used.